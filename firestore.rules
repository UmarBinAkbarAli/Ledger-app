rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ======================================================
    // AUTH HELPERS
    // ======================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function userId() {
      return request.auth.uid;
    }

    // âœ… OPTIMIZED: Use custom claims directly instead of Firestore read
    // Custom claims are set during user creation and included in the auth token
    function userBusinessId() {
      return request.auth.token.businessId;
    }

    function userRole() {
      return request.auth.token.role;
    }

    function isAdmin() {
      return isAuthenticated() && 
             (request.auth.token.admin == true || userRole() == 'admin');
    }

    function isAccountant() {
      return isAuthenticated() && userRole() in ['accountant', 'admin'];
    }

    // ======================================================
    // TENANT ISOLATION HELPERS
    // ======================================================

    // Same business OR legacy ownership fallback
    function isBusinessMember(resourceData) {
      return
        (
          userBusinessId() != null &&
          resourceData.businessId != null &&
          userBusinessId() == resourceData.businessId
        )
        ||
        (
          resourceData.businessId == null &&
          resourceData.userId == userId()
        );
    }

    // Validate creation inside tenant
    function canCreateInBusiness(requestData) {
      return
        (
          userBusinessId() != null &&
          requestData.businessId == userBusinessId()
        )
        ||
        (
          userBusinessId() == null &&
          requestData.userId == userId()
        );
    }

    // User doc belongs to same business (legacy-safe)
    function isUserDocInBusiness(userData) {
      return
        (
          userBusinessId() != null &&
          userData.businessId != null &&
          userBusinessId() == userData.businessId
        )
        ||
        (
          userData.businessId == null &&
          userData.createdBy == userId()
        );
    }

    // ======================================================
    // BUSINESSES
    // ======================================================

    match /businesses/{businessId} {
      allow read: if isAuthenticated() && userBusinessId() == businessId;
      allow update: if isAdmin() && userBusinessId() == businessId;
      allow create: if isAuthenticated();
      allow delete: if false;
    }

    // ======================================================
    // USERS
    // ======================================================

    match /users/{uid} {
      // Read
      allow read: if
        uid == userId() ||
        (isAdmin() && isUserDocInBusiness(resource.data));

      // Create (first login)
      allow create: if
        uid == userId() &&
        canCreateInBusiness(request.resource.data);

      // Update
      allow update: if
        (
          // User updating own non-privileged fields
          uid == userId() &&
          request.resource.data.role == resource.data.role &&
          request.resource.data.status == resource.data.status &&
          request.resource.data.businessId == resource.data.businessId &&
          request.resource.data.createdBy == resource.data.createdBy
        )
        ||
        (
          // Admin updating users in same business
          isAdmin() &&
          isUserDocInBusiness(resource.data) &&
          request.resource.data.businessId == resource.data.businessId
        );

      // Delete
      allow delete: if isAdmin() && isUserDocInBusiness(resource.data);

      // -----------------------------
      // Subcollections (user-owned)
      // -----------------------------

      match /bankAccounts/{id} {
        allow read, write: if uid == userId();
      }

      match /pettyCash/{id} {
        allow read, write: if uid == userId();
      }

      match /summary/{id} {
        allow read, write: if uid == userId();
      }
    }

    // ======================================================
    // BUSINESS DATA COLLECTIONS
    // ======================================================

    match /customers/{id} {
      allow create: if isAuthenticated() && canCreateInBusiness(request.resource.data);
      allow read, update, delete: if isAuthenticated() && isBusinessMember(resource.data);
    }

    match /suppliers/{id} {
      allow create: if isAuthenticated() && canCreateInBusiness(request.resource.data);
      allow read, update, delete: if isAuthenticated() && isBusinessMember(resource.data);
    }

    match /sales/{id} {
      allow create: if isAuthenticated() && canCreateInBusiness(request.resource.data);
      allow read, update, delete: if isAuthenticated() && isBusinessMember(resource.data);
    }

    match /purchases/{id} {
      allow create: if isAuthenticated() && canCreateInBusiness(request.resource.data);
      allow read, update, delete: if isAuthenticated() && isBusinessMember(resource.data);
    }

    match /income/{id} {
      allow create: if isAuthenticated() && canCreateInBusiness(request.resource.data);
      allow read, update, delete: if isAuthenticated() && isBusinessMember(resource.data);
    }

    match /expenses/{id} {
      allow create: if isAuthenticated() && canCreateInBusiness(request.resource.data);
      allow read, update, delete: if isAuthenticated() && isBusinessMember(resource.data);
    }

    match /operationalExpenses/{id} {
      allow create: if isAuthenticated() && canCreateInBusiness(request.resource.data);
      allow read, update, delete: if isAuthenticated() && isBusinessMember(resource.data);
    }

    match /transfers/{id} {
      allow create: if isAuthenticated() && canCreateInBusiness(request.resource.data);
      allow read, update, delete: if isAuthenticated() && isBusinessMember(resource.data);
    }

    match /expenseCategories/{id} {
      allow create: if isAuthenticated() && canCreateInBusiness(request.resource.data);
      allow read, update, delete: if isAuthenticated() && isBusinessMember(resource.data);
    }

    match /pettyCashOpening/{id} {
      allow create: if isAuthenticated() && canCreateInBusiness(request.resource.data);
      allow read, update, delete: if isAuthenticated() && isBusinessMember(resource.data);
    }

    match /deliveryChallans/{id} {
      allow create: if isAuthenticated() && canCreateInBusiness(request.resource.data);
      allow read, update, delete: if isAuthenticated() && isBusinessMember(resource.data);
    }

    // ======================================================
    // AUDIT LOGS
    // ======================================================

    match /auditLogs/{id} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ======================================================
    // DEFAULT DENY
    // ======================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
